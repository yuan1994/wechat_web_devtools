'use strict';var _exports;function init(){function a(F){let H,I,J,G=0;if(0===F.length)return G;for(H=0,J=F.length;H<J;H++)I=F.charCodeAt(H),G=(G<<5)-G+I,G|=0;return 0<G?G:0-G}function b(){let F=JSON.stringify(w);localStorage.setItem('projectLists',F),g.writeFile(v,F)}function c(F,G){if(G){let P=F.projectpath,Q=f.join(__dirname,'../weapp/newquick/');try{let R=j.sync(`./**/**`,{cwd:Q});R.forEach(S=>{let T=f.join(Q,S),U=f.join(P,S),V=g.lstatSync(T);if(V.isDirectory())k.sync(U);else{let W=g.readFileSync(T);g.writeFileSync(U,W)}})}catch(R){h.error(`projectStores.js initProject error ${R.toString()}`)}}}function d(F,G=()=>{}){const H=require('../actions/windowActions.js');H.showConfirm({content:F,type:'alert',callback:G})}const f=require('path'),g=require('fs'),h=require('../common/log/log.js'),j=require('glob'),k=require('mkdir-p'),l=require('../common/request/request.js'),m=require('../config/urlConfig.js'),n=require('../config/errcodeConfig.js');require('../weapp/commit/unpack.js');const o=require('../config/dirConfig.js'),p=require('../utils/file.js'),q=require('events').EventEmitter,r='last-select-project',{SELECT_URL_TYPE:s,SELECT_UNKNOW_TYPE:t}=require('../config/config.js');let u=o.WeappProjectInfo;if(!u){const F=f.join(nw.App.getDataPath(),'..');u=f.join(F,'WeappProject')}const v=f.join(u,'projectinfo.json');var w=JSON.parse(localStorage.getItem('projectLists'))||[];g.writeFile(v,localStorage.getItem('projectLists')||'[]');var x={},y=null,z={},A=!1,B=parseInt(localStorage.getItem(r))||t;const C={Network:{RequestDomain:[],WsRequestDomain:[],UploadDomain:[],DownloadDomain:[]},Setting:{MaxLocalstorageSize:10,MaxCodeSize:5,MaxWebviewDepth:5,MaxBackgroundLifespan:300,MaxRequestConcurrent:5,MaxUploadConcurrent:1,MaxDownloadConcurrent:5,MaxFileStorageSize:100}};w.forEach(F=>{F.hash=a(F.projectid),F.es6===void 0&&(F.es6=!0),F.watcher===void 0&&(F.watcher=!0),F.editWebview===void 0&&(F.editWebview=!0),F.postcss===void 0&&(F.postcss=!0),F.urlCheck===void 0&&(F.urlCheck=!0),F.newFeature===void 0&&(F.newFeature={show:!1,check:!1,time:Date.now()}),global.appConfig.isBeta&&!1===F.newFeature.check&&(F.newFeature.check=!0),F.initPath===void 0&&(F.initPath={enable:!1,page:'',query:''}),F.uploadPath===void 0&&(F.uploadPath={enable:!1,page:'',query:''})});const D=(F,G)=>{if(!A){A=!0;let U=m.getWeappAttrURL,V=`${U}?appid=${F.appid}&_r=${Math.random()}`;h.info(`projectStores.js begin get projectAttr ${V}`),l({url:V,body:JSON.stringify({appid_list:[F.appid]}),method:'post',needToken:1},(W,X,Y)=>{if(A=!1,W)return h.error(`projectStores.js end requestProjectAttr network error: ${JSON.stringify(W)}`),void G(W);h.info(`projectStores.js end requestProjectAttr ${Y}`);let Z;try{Z=JSON.parse(Y)}catch(aa){return h.error(`projectStores.js end requestProjectAttr parse body error: ${Y} ${JSON.stringify(W)}`),void G(`系统错误 ${Y}`)}let $=Z.baseresponse,_=$?parseInt($.errcode):0;if(0===_){let aa=Z.attr_list[0],ba=aa.jsapi_list,ca={};if(ba&&0<ba.length){for(let da=0;da<ba.length;da++){let ea=ba[da];ca[ea.name]=ea}delete aa.jsapi_list,aa.permission=ca}G(null,aa)}else _===n.DEV_App_Not_Band&&(d('\u5F53\u524D\u5F00\u53D1\u8005\u672A\u7ED1\u5B9A\u6B64 appid \uFF0C\u8BF7\u5230 mp \u540E\u53F0\u64CD\u4F5C\u540E\u91CD\u8BD5',()=>{nw.Shell.openExternal('https://mp.weixin.qq.com/')}),h.error(`projectStores.js setProjectConfig error ${_}`)),G(`系统错误 ${Y}`)})}},E=Object.assign({},q.prototype,{getLastSelect:function(){if(B===s||B===t)return parseInt(B);let F=this.getProjectByHash(B);if(F){let G=`projectattr${F.hash}`,H;try{H=JSON.parse(localStorage.getItem(G))}catch(J){return t}let I=F.isTourist;if(H||I)return E.setProjectConfig(F,()=>{}),F}return t},setProjectType:function(F){B=F,localStorage.setItem(r,F)},getCurrentProject:function(){return y},getCurrentProjectConfig:function(){return this.getProjectConfig(y)},setProjectPostCss:function(F,G){let H=this.getProjectByHash(F);H.postcss=G,b()},setProjectEs6:function(F,G){let H=this.getProjectByHash(F);H.es6=G,b(),this.emit('PROJECT_STORES_CONFIG_CHANGE',H)},setProjectUrlCheck:function(F,G){let H=this.getProjectByHash(F);H.urlCheck=G,b(),this.emit('PROJECT_STORES_CONFIG_CHANGE',H)},setProjectMinified:function(F,G){let H=this.getProjectByHash(F);H.minified=G,b()},setProjectEditWebview:function(F,G){let H=this.getProjectByHash(F);H.editWebview=G,b(),this.emit('PROJECT_STORES_CHANGE_EDIT_WEBVIEW',H,G)},setProjectNewFeature:function(F,G){let H=this.getProjectByHash(F);H.newFeature=G,b(),this.emit('PROJECT_STORES_CONFIG_CHANGE',H)},setProjectWatcher:function(F,G){let H=this.getProjectByHash(F);H.watcher=G,b()},setProjectInitPath:function(F,G){let H=this.getProjectByHash(F);H.initPath=G,b()},setProjectUploadPath:function(F,G){let H=this.getProjectByHash(F);H.uploadPath=Object.assign({},H.uploadPath,G),b()},getProjectByHash:function(F){return F=parseInt(F),w.find(G=>{return G.hash===F})},getProjectByID:function(F){return w.find(G=>{return G.projectid===F})},getProjectList:function(){return w},addVerifyProject:function(F,G){},add:function(F,G){F.hash=a(F.projectid),F.es6=!0,F.watcher=!0,F.editWebview=!0,F.newFeature={time:Date.now(),show:!1,check:!1},F.initPath={enable:!1},F.uploadPath={enable:!1},w.unshift(F),c(F,G),b(),h.info(`projectStores.js add ${JSON.stringify(F)}`),this.emit('ADD_PROJECT',w)},del:function(F){let G=w.findIndex(H=>{return H.projectid===F});if(-1<G){let H=w[G];delete localStorage[`projectattr${H.hash}`],w.splice(G,1),b(),p.cleanProjectFile(H,!0),h.info(`projectStores.js del ${F}`),this.emit('DEL_PROJECT',w)}},close:function(){this.emit('CLOSE_PROJECT')},restart:function(F){this.emit('RESTART_PROJECT',F)},getProjectConfig:function(F){return x[F.hash]},setProjectConfig:function(F,G){if(y=F,F.isTourist){let J=Object.assign({},C);return J.appid=F.appid,x[F.hash]=J,void G()}let I,H=`projectattr${F.hash}`;try{I=JSON.parse(localStorage.getItem(H))}catch(J){h.error('projectStores.js setProjectConfig parse localStorage projectAttr error')}I&&I.permission&&(x[F.hash]=I,G()),D(F,(J,K)=>{J?'NOT_LOGIN'===J.type?d('\u767B\u5F55\u6001\u5931\u6548\uFF0C\u8BF7\u91CD\u65B0\u767B\u5F55'):!I&&d(J):(x[F.hash]=K,localStorage.getItem(H)!=JSON.stringify(K)&&(localStorage.setItem(H,JSON.stringify(K)),this.emit('PROJECT_STORES_CONFIG_CHANGE',F)),!I&&G()),this.emit('PROJECT_CONFIG_REFRESHED')})},getSdkUserAuthStorage:function(F){if(z[F.hash])return z[F.hash];let G=`projectuserauth_${F.hash}`,H={};try{H=JSON.parse(localStorage.getItem(G))||{}}catch(I){localStorage.setItem(G,'{}'),h.error('projectStores.js getSdkUserAuthStorage parse localStorage Sdk error')}return z[F.hash]=H||{},z[F.hash]},setUserAuthPemissionStorage:function(F,G){z[F.hash]&&(z[F.hash]=G||{});let H=`projectuserauth_${F.hash}`;localStorage.setItem(H,JSON.stringify(G||{}))}});_exports=E}init(),module.exports=_exports;