'use strict';var _exports;function init(){const a=require('../../lib/react.js');require('../../stores/windowStores.js');const c=require('../../actions/windowActions.js');require('../../cssStr/cssStr.js');const d=require('../../weapp/commit/upload.js'),e=require('../../common/request/request.js'),{uploadQrCodeURL:f,refreshUploadConfirm:g}=require('../../config/urlConfig.js'),h=require('../../config/errcodeConfig.js'),i=300000,j={ERR_UUID:1,EXPIRE_UUID:2,WAITING_SCAN:3,WAITING_CONFIRM:4,CONFIRM:5},k=function(n){c.showTipsMsg({msg:n,type:'error'})},l=function(n,o){c.showConfirm({content:n,callback:o})},m=a.createClass({displayName:'UploadInfo',getInitialState:function(){return{show:!1,showDialog:!1,showQrcode:!1,waitingConfirm:!1,qrcode_img:'',qrcode_id:'',version:'',desc:'',saveBtnTitle:'\u4E0A\u4F20',saveBtnClass:'detail-upload-dialog-button-primary'}},startUpload:function(){this.setState({showQrcode:!1,showDialog:!1,waitingConfirm:!1});let n=this.props.project.appid,o={url:`${f}?appid=${n}`,method:'get',needToken:1};e(o,(p,q,r)=>{if(!p&&200===q.statusCode){r=JSON.parse(r);let s=r.baseresponse;0==s.errcode?1==r.is_experience?l('\u60A8\u7684\u4E0A\u6B21\u63D0\u4EA4\u5DF2\u88AB\u9009\u4E3A\u4F53\u9A8C\u7248\uFF0C\u672C\u6B21\u4E0A\u4F20\u5C06\u4F1A\u8986\u76D6\u4F53\u9A8C\u7248\uFF0C\u662F\u5426\u7EE7\u7EED\uFF1F',u=>{u&&this.showQrcodeWnd(r.qrcode_img,r.wxa_uuid)}):this.showQrcodeWnd(r.qrcode_img,r.wxa_uuid):s.errcode==h.DEV_Need_Admin?l('\u9700\u8981\u7BA1\u7406\u5458\u624D\u80FD\u8FDB\u884C\u4E0A\u4F20\u64CD\u4F5C\uFF0C\u8BF7\u68C0\u67E5\u540E\u91CD\u8BD5'):l('\u83B7\u53D6\u4E8C\u7EF4\u7801\u5931\u8D25\uFF01'+s.errcode)}})},showQrcodeWnd:function(n,o){this.setState({qrcode_img:n,qrcode_id:o,showQrcode:!0,showDialog:!1}),this.startRefreshTime=Date.now(),this.startRefreshConfirm()},startRefreshConfirm:function(){return clearTimeout(this.timeId),Date.now()-this.startRefreshTime>i?(k('\u4E8C\u7EF4\u7801\u5DF2\u8FC7\u671F\uFF01'),void this.setState({showQrcode:!1,showDialog:!1})):void(this.timeId=setTimeout(()=>{if(!this.state.showDialog){let v={appid:this.props.project.appid,wxa_uuid:this.state.qrcode_id},w={url:g,body:JSON.stringify(v),method:'post',needToken:1};e(w,(x,y,z)=>{if(!x&&200===y.statusCode){z=JSON.parse(z);let A=z.baseresponse;if(0==A.errcode)switch(z.qrcode_state){case j.ERR_UUID:{k('\u4E8C\u7EF4\u7801\u9519\u8BEF\uFF01'),clearTimeout(this.timeId);break}case j.EXPIRE_UUID:{k('\u4E8C\u7EF4\u7801\u5DF2\u8FC7\u671F\uFF01'),clearTimeout(this.timeId);break}case j.WAITING_SCAN:break;case j.WAITING_CONFIRM:{this.setState({waitingConfirm:!0});break}case j.CONFIRM:{this.setState({showQrcode:!1,showDialog:!0}),clearTimeout(this.timeId);break}}else k('\u83B7\u53D6\u4E8C\u7EF4\u7801\u72B6\u6001\u5931\u8D25\uFF01'),clearTimeout(this.timeId)}}),this.startRefreshConfirm()}},3000))},save:function(){if(!this.lock&&this.state.showDialog){if(!this.state.version)return void k('\u8BF7\u586B\u5199\u7248\u672C\u4FE1\u606F');if(!this.state.desc)return void k('\u8BF7\u586B\u5199\u63CF\u8FF0\u4FE1\u606F');this.setState({saveBtnClass:'detail-upload-dialog-button-primary detail-upload-dialog-button-primary-loading',saveBtnTitle:'\u4E0A\u4F20\u4E2D'}),this.lock=!0;let v={version:this.state.version,desc:this.state.desc,uuid:this.state.qrcode_id};d.upload(this.props.project,v,(w,x,y,z)=>{this.getResp({error:w,resp:x,res:y,options:z,type:'upload'})})}},cancel:function(){this.lock||this.setState({showQrcode:!1,showDialog:!1})},versionChange:function(n){let o=n.target.value;o=o.replace(/[^0-9a-zA-Z\.]/g,''),this.setState({version:o})},descChange:function(n){let o=n.target.value;this.setState({desc:o})},getResp:function(n){this.setState({saveBtnClass:'detail-upload-dialog-button-primary',saveBtnTitle:'\u4E0A\u4F20',showDialog:!1,showQrcode:!1}),this.lock=!1,this.props.getResp(n)},render:function(){let n=this.state.showDialog||this.state.showQrcode,o='';if(this.state.qrcode_img){let p=+new Date+i,q=new Date(p);o=this.state.waitingConfirm?'\u626B\u7801\u6210\u529F\uFF0C\u8BF7\u5728\u624B\u673A\u4E0A\u786E\u8BA4':`请使用管理员的微信号扫描二维码，并在微信上确认。二维码将在 ${q.toTimeString().replace(/\s.*/g,'')} 失效。`}return a.createElement('div',{style:{marginTop:-51,display:n?'':'none'},className:'detail-upload-dialog'},a.createElement('div',{className:'detail-upload-dialog-hd'},a.createElement('h3',{className:'detail-upload-dialog-hd-title'},'\u4E0A\u4F20\u786E\u8BA4')),a.createElement('div',{style:{display:this.state.showDialog?'':'none'}},a.createElement('div',{className:'detail-upload-dialog-bd'},a.createElement('p',{className:'detail-upload-dialog-tips'},'\u4E0A\u4F20\u540E\uFF0C\u53EF\u4EE5\u5728\u516C\u4F17\u5E73\u53F0\u67E5\u770B\u672C\u7248\u672C'),a.createElement('div',{className:'detail-upload-dialog-form'},a.createElement('div',{className:'detail-upload-dialog-form-item'},a.createElement('label',{className:'detail-upload-dialog-form-label'},'\u7248\u672C\u53F7'),a.createElement('div',{className:'detail-upload-dialog-form-input-box'},a.createElement('input',{onChange:this.versionChange,value:this.state.version,type:'text',maxLength:'10',className:'detail-upload-dialog-form-input'}),a.createElement('p',{className:'detail-upload-dialog-form-tips'},'\u5408\u7406\u8BBE\u7F6E\u7248\u672C\u53F7\u4FBF\u4E8E\u7BA1\u7406\uFF0C\u53EA\u80FD\u8F93\u5165\u5B57\u6BCD\u3001\u6570\u5B57\u3001. \u5982 v1.0.0 '))),a.createElement('div',{className:'detail-upload-dialog-form-item'},a.createElement('label',{className:'detail-upload-dialog-form-label'},'\u9879\u76EE\u5907\u6CE8'),a.createElement('div',{className:'detail-upload-dialog-form-input-box'},a.createElement('input',{onChange:this.descChange,value:this.state.desc,type:'text',maxLength:'100',className:'detail-upload-dialog-form-input'}),a.createElement('p',{className:'detail-upload-dialog-form-tips'},'\u53EF\u4EE5\u5907\u6CE8\u9879\u76EE\u7248\u672C\u4F18\u5316\u5185\u5BB9\u7B49\uFF0C\u4FBF\u4E8E\u7BA1\u7406\u5458\u8BC6\u522B'))))),a.createElement('div',{className:'detail-upload-dialog-ft'},a.createElement('a',{onClick:this.cancel,href:'javascript:;',className:'detail-upload-dialog-button-default'},'\u53D6\u6D88'),a.createElement('a',{onClick:this.save,href:'javascript:;',style:{display:this.props.isTourist?'none':''},className:this.state.saveBtnClass},this.state.saveBtnTitle))),a.createElement('div',{style:{display:this.state.showQrcode?'':'none'}},a.createElement('div',{className:'setting-bd'},a.createElement('img',{src:'data:image/png;base64,'+this.state.qrcode_img,style:{width:'200px',heigth:'200px',marginBottom:'20px'}}),a.createElement('p',null,o)),a.createElement('div',{className:'detail-upload-dialog-ft'},a.createElement('a',{onClick:this.cancel,href:'javascript:;',className:'detail-upload-dialog-button-default'},'\u53D6\u6D88'))))}});_exports=m}init(),module.exports=_exports;