'use strict';var _exports;function init(){const a=require('../../lib/react.js'),b=require('../../lib/react-dom.js'),c=require('../../cssStr/cssStr.js'),d=require('../../stores/webviewStores.js'),e=require('../../stores/windowStores.js');require('./../../common/log/log.js');const f=a.createClass({displayName:'DevTools',hideAllDevtools:function(){let g=this.refs.container.childNodes;for(let h=0;h<g.length;h++)g[h].style.cssText='width:0.1px;height:0.1px'},_changeWebviewID:function(g){this.hideAllDevtools();let h=b.findDOMNode(this.refs.container).querySelector(`.devtools${g}`);h&&(h.style.cssText=`height:${global.contentDocument.querySelector('.debugger').clientHeight}px`)},_setWebviewInfo:function(g){let h={width:g.width,height:g.height,dpr:g.dpr};this.postMessageToAllDevview('webframe',h,'setEmulate')},_closeWebviewDevtools:function(g){let h=b.findDOMNode(this.refs.container).querySelector(`.devtools${g}`);h&&h.parentNode.removeChild(h)},_openWebviewDevtools:function(g,h,j){this.hideAllDevtools();let k=this.devtoolsview=document.createElement('webview');k.className=`devtools-content devtools${g}`,k.setAttribute('partition','persist:devtools');let l=`${k.getUserAgent()} webview/${10000+g} chromeRuntimeID/${chrome.runtime.id}`;k.setUserAgentOverride(l),this.addContentScripts(),this.initRuntime(g),k.addEventListener('contentload',m=>{this.postMessage(g,{command:'init',msg:{width:j.width,height:j.height,dpr:j.dpr},to:'webframe'})}),k.src='about:blank',this.refs.container.appendChild(k),k.addEventListener('loadcommit',()=>{h.showDevTools(!0,k),k.style.height=`${global.contentDocument.querySelector('.debugger').clientHeight}px`})},addContentScripts:function(){this.devtoolsview.addContentScripts([{name:'myRules',matches:['<all_urls>'],js:{files:['app/dist/contentscript/contentScript.js']},run_at:'document_start'}])},port:{},getWebviewPortName:function(g){return`webview${10000+g}`},initRuntime:function(g){chrome.runtime.onConnect.addListener(h=>{let j=this.getWebviewPortName(g);h.name===j&&(this.port[g]=h,h.onMessage.addListener(l=>{this.onMessage(g,l)}),h.onDisconnect.addListener(()=>{delete this.port[g]}),this.postMessage(g,{command:'SHAKE_HANDS',to:'contentscript'}))})},onMessage:function(g,h){h=h||{};let j=h.type;'alert'===j&&alert(h.msg);let k=h.command;'INIT_DEVTOOLS_SUCCESS'===k&&e.emit(`INIT_DEVTOOLS_SUCCESS${g}`)},msgQuery:{},postMessage:function(g,h){let j=this.port[g];if(!j)return this.msgQuery[g]=[],void this.msgQuery[g].push(h);this.msgQuery[g]&&(this.msgQuery.forEach(k=>{this.port.postMessage(k)}),delete this.msgQuery[g]);j.postMessage(h)},postMessageToAllDevview:function(g,h,j,k){let l={to:g,msg:h,command:j,ext:k};for(let m in this.port)l.webviewID=parseInt(m),this.postMessage(m,l)},componentDidMount:function(){d.on('CHANGE_WEBVIEW_ID',this._changeWebviewID),e.on('SET_WEBVIEW_INFO',this._setWebviewInfo),e.on('OPEN_WEBVIEW_DEVTOOLS',this._openWebviewDevtools),e.on('CLOSE_WEBVIEW_DEVTOOLS',this._closeWebviewDevtools)},componentWillUnmount:function(){d.removeListener('CHANGE_WEBVIEW_ID',this._changeWebviewID),e.removeListener('SET_WEBVIEW_INFO',this._setWebviewInfo),e.removeListener('OPEN_WEBVIEW_DEVTOOLS',this._openWebviewDevtools),e.removeListener('CLOSE_WEBVIEW_DEVTOOLS',this._closeWebviewDevtools)},render:function(){let g='devtools'===this.props.show?{height:'100%'}:c.webviewDisplayNone;return a.createElement('div',{style:g,ref:'container',className:'devtools'})}});_exports=f}init(),module.exports=_exports;