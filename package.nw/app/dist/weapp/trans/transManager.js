'use strict';var _exports;function init(){function a(v,w){if(!v.error)w(null,{},v.data);else if('object'==typeof v.error){let x=v.error||{},y=x.httpCode||404,z=x.msg||x.toString();w(y,{},z),(x.type===q||x.type===r)&&k.showWeappError(x.type,x.type===q?m.parseWxssErr(x):x)}else w(404,{'Weapp-Error':encodeURIComponent(v.error)},v.error.toString())}require('fs');const b=require('path'),c=require('async'),d=require('../utils/tools.js');require('../../stores/projectStores.js');const f=require('./transConfigToPf.js'),g=require('./transWxmlToJs.js'),h=require('./transWxmlToHtml.js'),i=require('../utils/projectManager.js'),j=require('./transWxssToCss.js'),k=require('../../actions/windowActions.js'),l=require('url'),m=require('../utils/parseErr.js'),{WXML_ERROR:n,PAGE_DEFINE_ERROR:o,WXSS_ERROR:q,WXSS_IMPORT_ERROR:r,WXML_LOSE_ERROR:s}=require('../../config/config.js'),{weappLocalIdRegular:t}=require('../../config/config.js');var u=require('../tpl/errorTpl.js');_exports={getResponse:function(w,x){let y=d.getProject(w),z=d.getFileNameFromUrl(w,y);z=decodeURI(z);let A=d.isWxmlFile(z),B=d.isWxssFile(z);if(B)j(w,{project:y},(C,D)=>{a({error:C,data:D},x)});else if(!A){let C=l.parse(w),D=C.pathname;b.basename(D);let E=b.extname(z);d.whiteFileExtName[E]?i.getFile(y,z,(F,G)=>{a({error:F,data:G},x)}):a({error:'404'},x)}else{let C=[];C.push(D=>{let E=i.getAppJSONSync(y),F=E.pages,G=z.replace(b.extname(z),''),H=F.findIndex(I=>{return I===G});-1<H?D(null,H):D({type:o,msgForConsole:`${o}app.json 中未配置，当前页面 ${G} 请检查后重试。`,msg:`app.json 中未配置当前页面 <br> ${G} <br>请检查后重试。`})}),C.push(D=>{f(y,{url:w},(E,F)=>{D(E,F)})}),C.push(D=>{g(w,{project:y},(E,F)=>{D(E,F)})}),c.parallel(C,(D,E)=>{if(D){let I=u.replace(/{{error}}/,()=>{return D.msg}).replace(/{{msgForConsole}}/,()=>{let K,J=D.type;return J===n?K=m.parseWxmlErr(y,D.msgForConsole):J===o?K=D.msgForConsole:J===s&&(K=m.parseWxmlLoseErr(y,D.msgForConsole)),K});return void x(500,{},I)}let F={};try{F=i.getPageJSONSync(y,w)}catch(I){k.showWeappError(I.type,m.parseJsonParseErr(I))}let G={config:F,project:y,url:w,pageFrameTpl:E[1],generateFunc:E[2].generateFunc},H=h(G);x(null,H.header,H.body)})}}}}init(),module.exports=_exports;