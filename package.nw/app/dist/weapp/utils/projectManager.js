'use strict';var _exports;function init(){function a(){for(let B in r.info(`projectManager.js cleanProjects`),w)w[B].watcher&&w[B].watcher.close();w={}}function b(B){let C=B.hash;if(!w[C]){A.project=B,1<Object.keys(w).length&&a(),r.info(`manager.js initProject projectid ${B.projectid}`);let D={cache:{},wxmlFileList:[],jsFileList:[]};w[C]=D,D.watcher=o.watch(B.projectpath,{ignored:[/node_modules/],ignoreInitial:!0,ignorePermissionErrors:!0,followSymlinks:!0,interval:1000,binaryInterval:1000}).on('all',(E,F,G)=>{let H=k.extname(F);s.whiteFileExtName[H]&&(F=k.relative(B.projectpath,F),c(B,E,F,G))}),D.watcher.on('error',E=>{E&&!z&&(r.error(`projectManager.js obj.watcher error ${E.toString()}`),z=!0,a(),b(B))})}}function c(B,C,D,E){let F=B.hash,G=w[F].cache;D=D.replace(/\\/g,'/'),'app.json'===D&&(w[F].cache={}),D&&G[D]&&(delete G[D],delete G['app-config.json']);let H=k.extname(D);'.wxml'===H?(clearTimeout(x),w[F].wxmlFileList=[],x=setTimeout(()=>{d(B)},20)):'.js'===H&&(clearTimeout(y),w[F].jsFileList=[],y=setTimeout(()=>{f(B)},20)),A.fileChange(B,C,D,E)}function d(B,C){try{let D=n.sync(`./**/*.wxml`,{nodir:!0,cwd:B.projectpath,ignore:['node_modules/**/*']}),E=B.hash;w[E].wxmlFileList=D,C&&C(null,D)}catch(D){r.error(`projectManager.js findAllWXMLFiles ${D.toString()}`),C&&C(D,[])}}function f(B,C){try{let D=n.sync(`**/*.js`,{nodir:!0,cwd:B.projectpath,ignore:['node_modules/**/*']}),E=B.hash;w[E].jsFileList=D,C&&C(null,D)}catch(D){r.error(`projectManager.js findAllJSFiles ${D.toString()}`),C&&C(D,[])}}function g(B,C){b(B);let D=B.hash,E=l.parse(C),F=E.pathname.replace(/^\//,''),G=k.extname(F),H=G?F.replace(G,'.json'):`${F}.json`,I=w[D].cache;if(I[H])return I[H];let J=B.projectpath,K=h(B),L=k.join(J,H),M=j.existsSync(L),N={};if(M){let O=j.readFileSync(L,'utf8');try{N=JSON.parse(O)}catch(P){throw{e:P,data:O,type:u.JSON_PARSE_ERROR,file:H}}}return I[H]=Object.assign({},K.window,N),I[H]}function h(B){b(B);let C=B.hash,D='app.json',E=w[C].cache,F=E[D];if(F)return F;let I,G=B.projectpath,H=k.join(G,'app.json');try{I=j.readFileSync(H,'utf8')}catch(M){throw{e:M,type:u.JSON_FILE_ERROR,file:'app.json'}}try{F=JSON.parse(I)}catch(M){throw{e:M,type:u.JSON_PARSE_ERROR,file:'app.json',data:I}}let J=F.pages;if(!J||0===J.length)throw{type:u.JSON_ENTRANCE_ERROR,file:'app.json',data:I};let K=F.tabBar;if(K){let M=[];if('[object Array]'!=Object.prototype.toString.call(K.list))M.push('tabBar.list \u5E94\u4E3A\u6570\u7EC4');else if(!K.list||2>K.list.length)M.push('tabBar.list \u9700\u81F3\u5C11\u5305\u542B\u4E24\u4E2A\u9879\u76EE');else if(5<K.list.length)M.push('tabBar.list \u4E0D\u80FD\u8D85\u8FC7 5 \u4E2A\u914D\u7F6E\u9879');else for(var L=0;L<K.list.length;L++){let N=K.list[L];if('[object Object]'!=Object.prototype.toString.call(N)){M.push(`tabBar.list[${L}] 需为 Object`);continue}let O=K.list[L].pagePath;if('[object String]'!=Object.prototype.toString.call(O)){M.push(`tabBar.list[${L}].pagePath 需为 String`);continue}2<=O.split('?').length?M.push(`tabBar.list[${L}].pagePath 不应该包含'?'`):2<=O.split('.').length&&M.push(`tabBar.list[${L}].pagePath 不应该包含'.'`)}if(0<M.length)throw{type:u.JSON_CONTENT_ERROR,file:'app.json',data:M.join('\n')}}return F.window||(F.window={}),E[D]=F,F}const j=require('fs'),k=require('path'),l=require('url'),m=require('events').EventEmitter,n=require('glob'),o=require('chokidar'),q=require('babel-core'),r=require('../../common/log/log.js'),s=require('./tools.js'),t=require('../../stores/projectStores.js'),u=require('../../config/config.js'),v=s.noBrowser.join(',');var w={},x,y,z=!1;t.on('PROJECT_STORES_CONFIG_CHANGE',B=>{let C=B.hash;r.info(`projectManager.js project config change`),w[C]&&(w[C]={cache:{},wxmlFileList:{},jsFileList:{}})});var A=Object.assign({},m.prototype,{fileChange:function(B,C,D,E){this.emit('FILE_CHANGE',B,C,D,E)},stopWatch:function(){a()},restartWatch:function(){b(this.project)}});_exports={manager:A,getFile:function(C,D,E){b(C);let F=C.hash,G=w[F].cache;if(G[D])return void process.nextTick(()=>{E(G[D].error,G[D].data)});let H=k.join(C.projectpath,D);j.readFile(H,(I,J)=>{I||(G[D]={error:I,data:J}),E(I,J)})},getAllWXMLFileList:function(C,D){b(C);let E=C.hash,F=w[E].wxmlFileList;F.length?process.nextTick(()=>{D(null,F)}):d(C,D)},getAllJSFileList:function(C,D){b(C);let E=C.hash,F=w[E].jsFileList;F.length?process.nextTick(()=>{D(null,F)}):f(C,D)},getScripts:function(C,D){let E=C.project,F=E.hash;b(E);let G=decodeURIComponent(C.fileName),H=w[F].cache;if(H[G])return void process.nextTick(()=>{D(H[G].error,H[G].data)});let I=E.es6,J=C.needRequire,K=k.join(E.projectpath,G);j.readFile(K,'utf8',(L,M)=>{if(L)return void D({e:L,type:u.PAGEJS_FILE_ERROR,file:G});if(I){let N=k.basename(G);try{let O=q.transform(M,{presets:['es2015'],sourceMaps:'inline',sourceFileName:N,babelrc:!1});M=O.code.replace('sourceMappingURL=data:application/json;','sourceMappingURL=data:application/json;charset=utf-8;')}catch(O){return void D({e:O,sourceFileName:N},M)}}M=`define("${G}", function(require, module, exports, ${v}){ ${M}\n});`,J&&(M+=`require("${G}")`),H[G]={error:null,data:M},D(null,M)})},getAppJSONSync:h,getAppEntranceSync:function(C,D={}){let E=s.getBaseURL(C);if(D.justHost)return E;let F=h(C)||{},G=F.pages||[],H=`${G[0]}.html`,I=C.initPath;return I&&I.enable&&(H=`${I.page}.html?${I.query}`),l.resolve(E,H)},getPageJSONSync:g,getAppConfigJSONSync:function(C){let D=C.hash,E=w[D].cache,F='app-config.json',G=E[F];if(G)return G;G={};let H=h(C)||{};G.pages=H.pages||[],G.entryPagePath=`${H.pages[0]}.html`,G.debug=H.debug||!1,G.networkTimeout=H.networkTimeout||{},G.global={window:H.window||{}},G.page={};var I=H.pages;for(var J=0;J<I.length;J++){var K=I[J],L=g(C,K)||{};G.page[`${K}.html`]={window:L}}if('[object Object]'==Object.prototype.toString.call(H.tabBar)){var M=Object.assign({},H.tabBar),N=[].concat(M.list||[]),O=[];for(var J=0;J<N.length;J++){var P=Object.assign({},N[J]);P.pagePath+='.html',O.push(P)}M.list=O,G.tabBar=M}return E[F]=G,G},isProjectPage:function(C,D){let E=h(C),F=E.pages||[];D=D.replace(/\\/g,'/');let G=F.findIndex(H=>{return H===D});return-1!==G}}}init(),module.exports=_exports;