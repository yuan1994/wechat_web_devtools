"use strict";var _exports;function init(){function a(y){return 0===Buffer.compare(new Buffer(y.toString(),"utf8"),y)}const b="darwin"===process.platform,c=global.appConfig.isDev,d=require("fs"),f=require("path"),g=require("../utils/tools.js"),h=require("glob"),j=require("async"),k=require("../../config/dirConfig.js"),l=k.WeappVendor,m=require("mkdir-p"),n=require("./initAppConfig.js"),o=require("./initAppServiceJs.js");require("child_process").spawn;const p=require("../../common/log/log.js"),q=require("babel-core"),r=require("autoprefixer"),s=require("postcss"),t=c?f.join(__dirname,"../vendor/"):l;b?f.join(t,"wcc"):f.join(t,"wcc.exe");const u=["iOS >= 8","Chrome >= 37"];let v=k.Weappdest;const w={".js":!0,".json":!0,".wxml":!0,".wcss":!0},x=g.whiteFileExtName;_exports=(y,z,A)=>{y.projectpath;let B=y.es6,C=y.minified,D=y.postcss,E=f.join(v,`${+new Date}`);m.sync(E);let F={};F.appconfig=G=>{n(y,z,(H,I)=>{G(H,I)})},F.appservicejs=G=>{o(y,z,(H,I)=>{G(H,I)})},j.parallel(F,(G,H)=>{return G?void A(G.toString()):void h("./**",{nodir:!0,cwd:y.projectpath,ignore:["./node_modules/**/*"]},(I,J)=>{for(let K=0;K<J.length;K++){let L=J[K],M=f.extname(L);if(!x[M])p.info(`build.js find file not in whiteList ${L}`);else{let N=f.join(E,L),O=f.dirname(N);m.sync(O);let P=d.readFileSync(f.join(y.projectpath,L));if(w[M]&&!a(P))return void A(`${L} - 不是 UTF8 编码，请检查后重试`);if(B&&".js"===M){let Q=P.toString();try{let R=q.transform(Q,{presets:["es2015"],babelrc:!1,minified:C,comments:!C});d.writeFileSync(N,R.code)}catch(R){return void A(`${L} - ${R}`)}}else if(D&&".wxss"===M){let Q=P.toString();try{let R=s([r({browsers:u})]).process(Q).css;d.writeFileSync(N,R,"utf8")}catch(R){return void A(R)}}else d.writeFileSync(N,P)}}A(null,E)})})}}init(),module.exports=_exports;