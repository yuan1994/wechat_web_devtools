'use strict';var _exports;function init(){const a=require('fs'),b=require('./pack.js'),c=require('./build.js'),d=require('path'),f=require('../../common/request/request.js'),g=require('../../config/dirConfig.js'),h=require('../../stores/projectStores.js'),i=require('../../config/urlConfig.js'),j=require('rmdir');_exports={};var k=g.Weappdest;_exports.uploadForTest=(l,m,n)=>{let o=h.getProjectConfig(l),p;try{p=o.Setting.MaxCodeSize}catch(s){p=1}let q=1024*p,r=!m.isBuildForUpload;c(l,{noCompile:!0},(s,t)=>{if(s)return void n(s.toString());let u=d.join(k,`${+new Date}.wx`);b(t,u,(v,w)=>{j(t,(A,B,C)=>{});let x=a.lstatSync(u),y=parseInt(x.size/1024);if(y>q)return a.unlink(u,()=>{}),void n(`代码包大小为 ${y} kb，超出限制 ${y-q} kb，请删除文件后重试`);let z;if(r){z=`${m.isNewFeature?i.testSourceNewFeatureURL:i.testSourceURL}?appid=${l.appid}`;let{page:A,query:B}=m;if(A){let C=encodeURIComponent(`${A}?${B}`);z=`${z}&path=${C}`}}else{let A=encodeURIComponent(m.desc),B=encodeURIComponent(m.version),C=encodeURIComponent(m.uuid);z=`${i.commitSourceURL}?appid=${l.appid}&user-version=${B}&user-desc=${A}&uuid=${C}`}f({url:z,method:'post',body:a.readFileSync(w),needToken:1},(A,B,C)=>{n(A,B,C,{MAX_APP_LENGTH:q}),a.unlink(u,()=>{})})})})},_exports.upload=(l,m,n)=>{m.isBuildForUpload=!0,_exports.uploadForTest(l,m,n)}}init(),module.exports=_exports;