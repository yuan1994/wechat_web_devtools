const http=require("http"),url=require("url"),zlib=require("zlib"),async=require("async"),Buffer=require("buffer").Buffer,util=require("./util"),log=require("../../../log/log.js");var defaultRule=require("./rule_default.js"),userRule=defaultRule;function userRequestHandler(a,b){function c(m){userRule.dealLocalResponse(a,l,function(n,o,p){k.endTime=new Date().getTime(),k.res={statusCode:n||"",headers:o||{}},k.resHeader=o||{},k.resBody=p,k.length=p?p.length:0,k.statusCode=n,b.writeHead(n,o),b.end(p),m&&m()})}function d(m){var n;g=userRule.replaceRequestProtocol(a,g)||g,n={hostname:i.hostname||a.headers.host,port:i.port||a.port||(/https/.test(g)?443:80),path:j,method:a.method,headers:a.headers},userRule.replaceRequestOption(a,n,function(){n.rejectUnauthorized=!1,l=userRule.replaceRequestData(a,l)||l,n.headers=util.lower_keys(n.headers),n.headers["proxy-connection"]&&(n.headers.connection=n.headers["proxy-connection"],delete n.headers["proxy-connection"]),n.headers["accept-language"]&&(n.headers["accept-language"]="zh-CN,zh;q=0.8,en;q=0.6,zh-TW;q=0.4"),n.headers["content-length"]=l.length;var o=(/https/.test(g)?https:http).request(n,function(p){var q=p.statusCode;q=userRule.replaceResponseStatusCode(a,p,q)||q;var r=userRule.replaceResponseHeader(a,p,p.headers)||p.headers;r=util.lower_keys(r);var s=/gzip/i.test(r["content-encoding"]),t=[];p.on("data",function(u){t.push(u)}),p.on("end",function(){var u;async.series([function(v){u=Buffer.concat(t),s?zlib.gunzip(u,function(w,x){u=x,v()}):v()},function(v){userRule.replaceServerResData?(u=userRule.replaceServerResData(a,p,u)||u,v()):userRule.replaceServerResDataAsync?userRule.replaceServerResDataAsync(a,p,u,function(w){u=w,v()}):v()},function(v){var w=userRule.pauseBeforeSendingResponse(a,p);w?setTimeout(v,w):v()},function(v){userRule.saveAllHttpResponse(a,q,r,u),b.writeHead(q,r),b.end(u),v()},function(v){k.endTime=new Date().getTime(),k.statusCode=q,k.resHeader=r,k.resBody=s?zlib.gunzipSync(u):u,k.length=u?u.length:0,v()},function(v){userRule.fetchTrafficData&&userRule.fetchTrafficData(-1,k),v()}],function(v,w){m&&m()})}),p.on("error",function(u){log.error("error"+u)})});o.on("error",function(p){log.error("err with request :"+p+"  "+a.url),b.end()}),o.end(l)})}var k,l,f=a.headers.host,g=!a.connection.encrypted||/^http:/.test(a.url)?"http":"https",h="http"===g?a.url:g+"://"+f+a.url,i=url.parse(h),j=i.path;k={host:f,method:a.method,path:j,protocol:g,url:g+"://"+f+j,req:a,startTime:new Date().getTime()},async.series([function(n){var o=[];a.on("data",function(p){o.push(p)}),a.on("end",function(){l=Buffer.concat(o),k.reqBody=l.toString(),n()})},function(n){userRule.shouldUseLocalResponse(a,l)?c(n):d(n)}],function(){})}function setRules(a){a&&(userRule=util.merge(defaultRule,a),"function"==typeof userRule.init&&userRule.init())}module.exports={userRequestHandler:userRequestHandler,setRules:setRules};