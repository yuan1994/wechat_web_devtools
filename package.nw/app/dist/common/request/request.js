'use strict';var _exports;function init(){function a(q){let r={};for(let s in q)'body'!==s&&(r[s]=q[s]);return JSON.stringify(r)}function b(q){let r=q.needToken,s=q.url;-1!==r&&(s=-1===s.indexOf('?')?`${s}?newticket=${q.newticket}`:`${s}&newticket=${q.newticket}`),(0===s.indexOf(k.CGI_DOMAIN)||0===s.indexOf(k.MP_DOMAIN)||0===s.indexOf(k.OPEN_DOMAIN))&&(s=-1===s.indexOf('?')?`${s}?os=${m}&clientversion=${o}`:`${s}&os=${m}&clientversion=${o}`),q.url=s}function c(q,r,s){require('../../stores/windowStores.js').getUserInfo();let t={url:n,form:JSON.stringify({openid:q,signature:r}),method:'post',needToken:-1};f(t,(u,v,w)=>{if(!u){i.info(`request.js refreshTicket ${w}`),w=JSON.parse(w);let x=w.baseresponse,y=parseInt(x.errcode);if(0!==y)return i.error(`request.js refreshTicket errcode: ${y}`),void s({type:'NOT_LOGIN'});let z=+new Date+1000*w.ticket_expired_time,A=v.headers,B=A['debugger-newticket'];require('../../actions/windowActions.js').upTicket(B,z),s(null,B)}else i.error(`request.js refreshTicket error ${JSON.stringify(u)}`),s(u)})}function d(q,r){j.parallel([function(t){let u=h.getProxyForURL(q.url);'DIRECT'!==u&&(q.proxy='http://'+u.replace('PROXY ',''),q.tunnel=p),t(null)},function(t){let u=q.needToken;if(-1===u)return void t(null);let v=1===u,w=require('../../stores/windowStores.js').getUserInfo();if(!w&&v)return i.error(`request.js setToken get userInfo null`),void t({type:'NOT_LOGIN'});let x=w.ticketExpiredTime,y=w.signatureExpiredTime,z=+new Date;return y<z&&v?(i.error(`request.js setToken signature expired ${y} ${z}`),void t({type:'NOT_LOGIN'})):void(x<z&&v?(i.error(`request.js setToken ticket expired ${x} ${z}`),c(w.openid,w.signature,(A,B)=>{A?(i.error(`request.js refreshTicket error ${JSON.stringify(A)}`),t({type:'NOT_LOGIN'})):(q.newticket=B,t(null))})):(q.newticket=w?w.newticket:'',t(null)))}],s=>{s?r(s,q):(b(q),delete q.newticket,delete q.needToken,r(null,q))})}function f(q,r){let s=JSON.parse(JSON.stringify(q)),t=q.needToken;-1!==q.loginForc,d(q,(u,v)=>{u?(r(u),i.error(`request.js makeRequestOpt _opt: ${a(v)}  error: ${JSON.stringify(u)}`),require('../../actions/windowActions.js').clearUserInfo()):g(v,(w,x,y)=>{if(w)i.error(`request.js request  ${v.url} error ${JSON.stringify(w)}`),'UNABLE_TO_VERIFY_LEAF_SIGNATURE'===w.code?(p=!confirm(`当前系统代理不是安全代理，是否信任？`),!p&&(v.tunnel=!1,g(v,(z,A,B)=>{r(z,A,B)}))):r(w);else{let z=x.statusCode;if(200!==z)return i.error(`request.js request ${v.url} statusCode ${z}`),void r(`网络错误 statusCode : ${z}`);if(1===t){let A;try{A=JSON.parse(y)}catch(D){return void r(D.toString())}let B=A.baseresponse||{},C=parseInt(B.errcode);if(C===l.DEV_Need_ReLogin||C===l.NOT_LOGIN||C===l.DEV_Invalid_Signature||C===l.DEV_Expired_Signature)return i.info(`request.js sendRequest get errcode ${C}`),r(C),void require('../../stores/webviewStores.js').emit('NOT_LOGIN');if(C===l.INVALID_TOKEN||C===l.INVALID_LOGIN)return require('../../stores/windowStores.js').delUserTicket(),r(C),void f(s,r)}r(w,x,y)}})})}const g=require('request'),h=require('../../utils/tools.js'),i=require('../log/log.js'),j=require('async'),k=require('../../config/urlConfig.js'),l=require('../../config/errcodeConfig.js'),m='darwin'===process.platform?'darwin':'win',n=k.refreshTicketURL,o=global.appVersion.replace(/\./g,'');var p=!0;_exports=f}init(),module.exports=_exports;