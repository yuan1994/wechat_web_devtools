'use strict';var _exports;function init(){require('os');const a=require('path');require('http');const b=require('../common/request/request.js'),c=require('fs'),d=require('../stores/windowStores.js'),f=require('../config/dirConfig.js');require('url'),nw.App;let g=f.WeappFileCache;const h='tmp',i='store',j='wxfile://';var k=function(l){let m,n=d.getUserInfo(),o=n?n.openid:'unknow';do m=`${h}_${l}${o}${+new Date}`;while(c.existsSync(a.join(g,m)));return m};_exports={createNewLocalId:function(l){return j+k(l.hash)},isAppTmpPath:function(l){return 0===l.indexOf(j)},getRealPath:function(l){if(this.isAppTmpPath(l)){let m=l.replace(j,'');return a.join(g,m)}return l},copyFileDataToTemp:function(l,m,n){let o=k(m);return c.writeFileSync(a.join(g,`${o}${n}`),l),`${j}${o}${n}`},copyFileToTemp:function(l,m,n){if(c.existsSync(l)){let o=c.readFileSync(l);return this.copyFileDataToTemp(o,m,n)}return!1},saveFileForever:function(l){let m=this.getRealPath(l);if(c.existsSync(m)){let n=l.replace(h,i);return c.renameSync(m,this.getRealPath(n)),n}return!1},uploadFileToServer:function(l){let{url:m,filePath:n,name:o,header:p,formData:q,tlsVersionCheck:r}=l,s={};r&&(s.secureProtocol='TLSv1_2_method'),p=p||{},q=q||{},q[o]=c.createReadStream(this.getRealPath(n)),b({url:m,agentOptions:s,method:'post',needToken:-1,headers:p,formData:q},(t,u,v)=>{l.callback&&l.callback(t,u,v)})},downloadFileFormServer:function(l){let{url:m,header:n,tlsVersionCheck:o}=l;n=n||{};let p={};o&&(p.secureProtocol='TLSv1_2_method'),b({url:m,agentOptions:p,method:'get',encoding:null,needToken:-1,headers:n},(q,r,s)=>{l.callback&&l.callback(q,r,s)})},getSavedFileList:function(l){let m=l.hash,n=d.getUserInfo(),o=n?n.openid:'unknow',p=c.readdirSync(g).filter(s=>{return!!~s.indexOf(`${i}_${m}${o}`)}),q=0,r=p.reduce((s,t)=>{let u=c.statSync(a.join(g,t));return q=u.size+q,s.push({filePath:`${j}${t}`,size:u.size,createTime:parseInt(u.ctime.getTime()/1000)}),s},[]);return{fileList:r,totalSize:q}},getFileStat:function(l){let n,m=this.getRealPath(l);return c.existsSync(m)&&(n=c.statSync(m)),n},removeSavedFile:function(l){let m=this.getRealPath(l),n=!1;return c.existsSync(m)&&(c.unlinkSync(m),n=!0),n},saveBase64DataToFile:function(l,m,n){let o=l.hash,p=new Buffer(m,'base64').toString('binary'),q=k(o);return c.writeFileSync(a.join(g,`${q}${n}`),p,'binary'),`${j}${q}${n}`},cleanProjectFile:function(l,m){let n=l.hash,o=d.getUserInfo(),p=o?o.openid:'unknow',q=c.readdirSync(g).filter(r=>{return!!~r.indexOf(m?`_${n}${p}`:`${h}_${n}${p}`)});q.map(r=>{c.unlinkSync(a.join(g,r))})},cleanTempFile:function(){try{c.readdirSync(g).map(l=>{0<=l.indexOf(h)&&c.unlinkSync(a.join(g,item))})}catch(l){}}}}init(),module.exports=_exports;